unit FileConfirm;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, ExplorerUtils, FileTransfer;

type
  TConfirmForm = class(TForm)
    Panel1: TPanel;
    Panel2: TPanel;
    Panel3: TPanel;
    Panel4: TPanel;
    Panel5: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label8: TLabel;
    Edit1: TEdit;
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Edit1KeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormCreate(Sender: TObject);
  private
    { Private 宣言 }
    FConfirmResult: TOverwritePromptResult;
    FOriginalFileName: string;
    FPanelIndex: Integer;
    function KeyToIndex(const Key: Char): Integer;
    procedure SetConfirmResult;
    procedure SetPanelForcus(const Index: Integer);
  public
    { Public 宣言 }
    procedure Init(const SrcFile, DestFile: string);
    property Result: TOverwritePromptResult read FConfirmResult;
    property IsRepeatSameOperation: Boolean read FIsRepeatSameOperation;
  end;

var
  ConfirmForm: TConfirmForm;

implementation

{$R *.dfm}

uses
  MainUnit;

procedure TConfirmForm.Edit1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var
  Dir: string;

begin
  if Key = VK_RETURN then
  begin
    Dir := ExtractFilePath(FOriginalFileName);
    if FileExists(Dir + Edit1.Text) then
      MainForm.AddOperationHistory('既に同じ名前のファイルが存在します')
    else
    begin
      SetConfirmResult;
      ModalResult := mrOK;
    end;
  end;
end;

procedure TConfirmForm.FormCreate(Sender: TObject);
begin
  SetPanelForcus(1);
end;

procedure TConfirmForm.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if Shift = [] then
  begin
    case Key of
      VK_DOWN: Inc(FPanelIndex);
      VK_UP:   Dec(FPanelIndex);
      VK_RETURN:
        begin
          SetConfirmResult;
          ModalResult := mrOK;
        end;
      VK_ESCAPE:
        begin
          FConfirmResult.Action := oaCancel;
          ModalResult := mrCancel;
        end;
    end;
    if (Key = VK_DOWN) or (Key = VK_UP) then
    begin
      if FPanelIndex < 1 then
        FPanelIndex := 1
      else
      if FPanelIndex > 3 then
        FPanelIndex := 3;
      SetPanelForcus(FPanelIndex);
    end;
    case Key of
      Ord('R'), Ord('S'), Ord('C'), Ord('F'):
      begin
        if FPanelIndex <> 3 then
          SetPanelForcus(KeyToIndex(Char(Key)));
      end;
    end;
  end;
  if ssShift in Shift then
  begin
    case Key of
      VK_RETURN:
        begin
          if FPanelIndex <> 3 then
          begin
            SetConfirmResult;
            ModalResult := mrOK;
          end;
        end;
    end;
  end;
end;

procedure TConfirmForm.Init(const SrcFile, DestFile: string);
var
  p1, p2: TFileInfo;

begin
  FConfirmResult.Action := oaYes;
  FConfirmResult.NewFileName := '';
  Edit1.Enabled := False;
  Edit1.Text := ExtractFileName(DestFile);
  FOriginalFileName := DestFile;
  p1 := GetFileProperty(SrcFile);
  p2 := GetFileProperty(DestFile);
  Label7.Caption := 'コピー元 : ' + FormatDateTime('[ yy/mm/dd hh:nn:sss ]', p1.LastWriteTime) +
    FormatFloat('#,##0', p1.FileSize) + ' Byte';
  Label8.Caption := 'コピー先 : ' + FormatDateTime('[ yy/mm/dd hh:nn:sss ]', p2.LastWriteTime) +
    FormatFloat('#,##0', p2.FileSize) + ' Byte';
  FPanelIndex := 1;
end;

function TConfirmForm.KeyToIndex(const Key: Char): Integer;
const
  Keys = 'RSCF';

begin
  Result := Pos(Key, Keys);
end;

procedure TConfirmForm.SetConfirmResult;
var
  Dir: string;

begin
  case FPanelIndex of
    1: FConfirmResult.Action := oaYes;
    2: FConfirmResult.Action := oaNo;
    3:
      begin
        Dir := ExtractFilePath(FOriginalFileName);
        FConfirmResult.Action := oaRename;
        FConfirmResult.NewFileName := Dir + Edit1.Text;
      end;
  end;
end;

procedure TConfirmForm.SetPanelForcus(const Index: Integer);
var
  i: Integer;

begin
  for i := 1 to 4 do
  begin
    TPanel(FindComponent('Panel' + i.ToString)).BevelInner := bvNone;
    TPanel(FindComponent('Panel' + i.ToString)).BevelOuter := bvNone;
  end;
  if Index = 3 then
  begin
    Edit1.Enabled := True;
    Edit1.SetFocus;
    Edit1.SelStart := Length(Edit1.Text);
  end else
    Edit1.Enabled := False;
  TPanel(FindComponent('Panel' + Index.ToString)).BevelInner := bvLowered;
  TPanel(FindComponent('Panel' + Index.ToString)).BevelOuter := bvRaised;
end;

end.
